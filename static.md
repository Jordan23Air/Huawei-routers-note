# 静态路由配置与管理
## 路由基础
“路由”简单的说就是报文从源端到目的端的整条传输路径。
## 路由分类
1. 静态路由
2. 直连路由
3. 动态路由 RIP OSPF IS-IS BGP 等

## 路由表和FIB表
路由器转发过程中的两张表 Routing Taible、Forwarding Information Base

### 路由表
每台运行动态路由协议的路由器至少有两张路由表，
1.本地核心路由表  
通常说的IP路由表，用来保存本地路由器到达网络中各目的地的**当前各种最佳协议路由，只有到达某一目的地到最佳路由才会出现在本地核心路由表里**，并负责把这些最佳路由表项下发给FIB表，生成对应的FIB表项，指导报文到转发。
2.协议路由表
存放着该协议已发现的所有路由信息，**但就所有路由来说，协议路由表发现到路由不一定是最佳路由，也就是不一定会最终用来进行数据报文路由。**路由协议可以引入并发布其他协议生成到路由。例如，在路由器上运行OSPF协议，需要使用OSPF系诶通告直连路由、静态路由或者IS-IS路由路由时，则要先将这些路由引入OSPF协议的路由表中。

查看路由器的IP路由表信息命令`display ip routing-table ` 

IP路由表包含以下字段。
1. Destination：路由的目的地址。用来表示IP包的目的地址或目的网络。
2. Mask：目的地址的子网掩码长度，与目的地址一起来标识目的主机或目的网络所在的网段地址。
3. Proto：学习此路由的路由协议。包括Static、Direct和各种动态路由。
4. Pre：preference，表示此路由协议优先级。用来比较不同协议类型、相同目的地址的多条路由的优先级。同一目的地可能存在不同的下一跳、出接口等多条路由，这些不同的路由可能是由不同的路由协议发现的，也可以是手工配置的静态路由，优先级高（树枝小）的将成为当前的最佳路由。
5. Cost：路由开销，**这是用来比较同一种协议类型、相同目的地址的多条路由的优先级**。但不同类型协议陆游的开销类型不同，如距离适量协议采用的是*距离*，即将*跳数*作为路由开销，而链路状态类协议采用的是*链路状态*（由链路带宽、网络传输性能等参数共同决定）作为路由开销。当到达同一目的地的多条路由具有相同的路由优先级时，路由开销最小的将成为当前的最佳路由。
6. NextHop：表示路由的下一跳IP地址。致命数据转发路径中的下一个三层设备。
7. Interface：表示此路由从本地设备发出的出接口。
在图10-1所示的网络中，路由器A与3个网络直接相连，因此在其Routing Table中有3个目的IP地址，下一跳和出接口的直连路由
![Alt text](./10-1.PNG)

### FIB表的匹配
 在IP路由表选择好要使用的路由表项后，把这些最佳路由表项下发给FIB表，生成对应的FIB表项。到组合。
查看FIB表信息命令 `display fib`

![Alt text](./FIB.PNG)

从中可以看出FIB表中包括Destination、Mask、Nexthop、Flag、TimeStamp、Interface和TunnelID字段，其中Destination、Mask、Nexthop、Interface和IP路由表到对应字段一样。其他3各字段说明如下。

1. Flag：转发表项的标志，可能是以下字母中一个或者多字母。
    * G（Gateway网关路由）：表示下一跳是网关。
    * H （Host主机路由）：表示路由为主机路由。
    * U （up可用路由）：表示路由状态是Up。
    * S （Static静态路由）：表示该路由为手动配置路由。
    * D（Dynamic动态路由）：表示该路由为根据路由算法自动生成的路由。
    * L（Vlink Route）：表示Vlink类型路由。
2. Timestamp：转发表项的时间戳，表示该表项已存在的时间，单位是s。
3. TurrnelID：表示转发表项索引。该值不为0时，表示匹配项的报文通过对应的隧道进行转发。该值为0时，表示报文不通过隧道转发。  

因为在iP封装中，**IP报文只封装了源IP地址和目的IP地址，没有封装对应的子网掩码。**所以这时如果在FIB表中有多条同时到达同一目的地，但处于相同自然网段的子网转发项时，就涉及最终选择哪条转发表的问题了。这就是FIB表中的*最长掩码*匹配原则，也即最惊喜路由匹配原则。具体方法是，在查找FIB表时，先将报文的目的地址与FIB中各表项的掩码按位进行*逻辑与*运算，得到匹配的网络地址（可能有多个），然后在这些对应的FIB表项中选择一个最长掩码的FIB表项进行报文转发。

例如，假设路由器上当前的FIB表如前所示，现有一个目的地址是9.1.2.1的报文进入路由器。首先，将目的地址9.1.2.1与FIB表中各表项的掩码长度*0、8、16*所对应的子网掩码进行*逻辑与*运算，得到下面几个网段地址：0.0.0.0/0、9.0.0.0/8、9.1.0.0/16.根据最长掩码匹配原则，最终会选择9.1.0.0/16表项从接口GE2/0/0转发这条目的地址是9.1.2.1的报文。

## 路由协议的优先级
在某一时刻到某一目的地的当前路由**仅能由唯一的路由协议来决定。*为了判断最佳路由，具有较高优先级的路由协议发现的路由将为最佳路有，并将最佳路由放入IP路由表中。

路由协议的优先级分为**外部优先级*和内部优先级*两种。选择路由时先比较路由的外部优先级，当不同的路由协议配置了相同的外部优先级时，系统才会通过内部优先级决定哪个路由协议发现的路由（内部优先级最高的）将成为最佳路由。**

**路由协议缺省时的外部优先级**

| 路由协议类型    | 路由协议的外不优先级| 
| ------------- |:-------------:| 
| DIRECT	 |0|
|OSPF     | 10 | 
|IS-IS    | 15 |  
|STATIC | 60   |  
| RIP| 100   |  
| OSPF ASE | 150     |  
| OSPF NSSA| 150     |  
| BGP | 255     |  
| EBGP | 255    |  

**路由协议内部优先级**

| 路由协议类型    | 路由协议的外不优先级| 
| ------------- |:-------------:| 
| DIRECT	 |0|
|OSPF     | 10 |  
|IS-IS LEVEL-1 |15  |  
| IS-IS LEVEL-2| 18   |  
| STATIC| 60    |  

## 路由的收敛

路由收敛是指网络拓扑变化引起的通过重新计算路有而发生替代路有的行为。路由收敛优先级从高到低分为*critical临界*、*high*、*medium*、*low* 4种。缺省情况下，公网路由收敛优先级如下表：

| 路由协议或路有种类   | 收敛优先级| 
| ------------- |:-------------:| 
| DIRECT	 |high|
|STATIC    | medium| 
|OSPF和IS-IS的32位主机路由     | medium|  
|OSPF除32位主机路由外| low  |  
| IS-IS除32为主机路由外 | low|  
| RIP | low     |  
| BGP      | low   |  

对于私网路由，除了OSPF和IS-IS的32为主机路由标识为medium外，其余路由统一标识为low。



